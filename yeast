#!/usr/bin/env bash

# yeast - Experimental AI proto-consciousness framework
# A local CLI that communicates with yeast-agent running on apollo.local
# Enables persistent identity, memory, and self-consistency exploration

set -euo pipefail

# Configuration
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
ENV_FILE="${SCRIPT_DIR}/.env"

# Default values (used if .env doesn't exist)
DEFAULT_APOLLO_HOST="apollo.local"
DEFAULT_APOLLO_USER="$USER"
DEFAULT_APOLLO_PORT="22"
DEFAULT_AGENT_PATH="~/yeast-agent"

# Global state
APOLLO_HOST=""
APOLLO_USER=""
APOLLO_PORT=""
AGENT_PATH=""
CONVERSATION_HISTORY=()
MAX_HISTORY_TURNS=10
DEBUG_MODE=false

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# ============================================================================
# Helper Functions
# ============================================================================

log_error() {
  echo -e "${RED}✗ Error: $*${NC}" >&2
}

log_warn() {
  echo -e "${YELLOW}⚠ $*${NC}" >&2
}

log_info() {
  echo -e "${BLUE}ℹ $*${NC}" >&2
}

log_success() {
  echo -e "${GREEN}✓ $*${NC}" >&2
}

show_help() {
  cat <<EOF
${CYAN}yeast${NC} - Experimental AI Proto-Consciousness Framework

${BLUE}Usage:${NC}
  yeast                    # Start interactive mode (default)
  yeast -p "question"      # One-shot question (headless)
  yeast -i, --interactive  # Explicitly start interactive mode
  yeast --setup            # Configure SSH to apollo
  yeast -h, --help         # Show this help

${BLUE}Examples:${NC}
  yeast                    # Opens interactive chat with persistent memory
  yeast -p "What are my drives?"
  yeast -p "Tell me about recent interactions"
  yeast --setup            # First time setup

${BLUE}Interactive Commands:${NC}
  /help      - Show available commands
  /clear     - Clear conversation history
  /inspect   - View current memory state
  /drives    - Show active drives
  /state     - Show internal state
  /refresh   - Refresh system memory
  /exit      - Exit interactive mode

${BLUE}About:${NC}
  yeast is an experimental framework for exploring persistent identity,
  memory, and self-consistency in AI systems using a local LLM (Mistral 7B).

  The system is stateless (the LLM) but maintains all persistence, identity,
  and memory externally. This is a research tool, not a consciousness claim.

EOF
}

# Check .env file exists (optional)
check_env() {
  if [ ! -f "$ENV_FILE" ]; then
    log_info ".env file not found, using defaults"
    return 0
  fi
  return 0
}

# Load and validate environment
load_env() {
  # Load .env if it exists, otherwise use defaults
  if [ -f "$ENV_FILE" ]; then
    # shellcheck disable=SC1090
    source "$ENV_FILE" 2>/dev/null || {
      log_warn "Failed to load .env file, using defaults"
    }
  fi

  # Use defaults if not set
  APOLLO_HOST="${APOLLO_HOST:-$DEFAULT_APOLLO_HOST}"
  APOLLO_USER="${APOLLO_USER:-$DEFAULT_APOLLO_USER}"
  APOLLO_PORT="${APOLLO_PORT:-$DEFAULT_APOLLO_PORT}"
  AGENT_PATH="${AGENT_PATH:-$DEFAULT_AGENT_PATH}"

  # Show what we're using
  if [ ! -f "$ENV_FILE" ]; then
    log_info "Using default connection: $APOLLO_USER@$APOLLO_HOST:$APOLLO_PORT"
    echo ""
    echo "  To customize, create: $ENV_FILE"
    echo "  Copy from: .env.example"
    echo ""
  fi
}

# Test SSH connection
test_ssh_connection() {
  log_info "Testing SSH connection to $APOLLO_USER@$APOLLO_HOST:$APOLLO_PORT"

  if ssh -p "$APOLLO_PORT" "$APOLLO_USER@$APOLLO_HOST" "echo 'SSH OK'" >/dev/null 2>&1; then
    log_success "SSH connection successful"
    return 0
  else
    log_error "SSH connection failed"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Check apollo is reachable: ping $APOLLO_HOST"
    echo "  2. Check .env credentials"
    echo "  3. Run: yeast --setup"
    echo ""
    exit 1
  fi
}

# Test yeast-agent availability
test_agent_availability() {
  log_info "Checking yeast-agent on apollo..."

  if ssh -p "$APOLLO_PORT" "$APOLLO_USER@$APOLLO_HOST" "test -f $AGENT_PATH" >/dev/null 2>&1; then
    log_success "yeast-agent available and ready"
    return 0
  else
    log_error "yeast-agent not found at $AGENT_PATH on apollo"
    echo ""
    echo "Please run: yeast --setup"
    echo ""
    exit 1
  fi
}

# Escape JSON string (bash-native)
json_escape() {
  local string="$1"
  # Order matters: escape backslashes first!
  string="${string//\\/\\\\}"
  string="${string//\"/\\\"}"
  # Replace actual newlines with \n escape sequence
  string="${string//$'\n'/\\n}"
  string="${string//$'\t'/\\t}"
  string="${string//$'\r'/\\r}"
  # Remove any control characters that might break JSON
  string="${string//$'\f'/}"
  string="${string//$'\b'/}"
  echo -n "$string"
}

# Send to yeast-agent via SSH
send_to_agent() {
  local user_input="$1"
  local command="$2"  # 'infer' or 'inspect'

  # Escape input for JSON
  local escaped_input
  escaped_input=$(json_escape "$user_input")

  # Build JSON request
  local json_request
  read -r -d '' json_request <<EOF || true
{
  "command": "$command",
  "input": "$escaped_input",
  "debug": $([[ "$DEBUG_MODE" == "true" ]] && echo "true" || echo "false")
}
EOF

  if [ "$DEBUG_MODE" = true ]; then
    echo "=== DEBUG: JSON Request ===" >&2
    echo "$json_request" >&2
    echo "===========================" >&2
  fi

  # Send request to agent via SSH (pipe JSON through stdin) with timeout
  local response
  response=$(printf "%s" "$json_request" | timeout 120 ssh -p "$APOLLO_PORT" "$APOLLO_USER@$APOLLO_HOST" \
    "python3 $AGENT_PATH" 2>&1) || {
    log_error "Failed to communicate with yeast-agent on apollo (timeout or connection error)"
    return 1
  }

  if [ "$DEBUG_MODE" = true ]; then
    echo "=== DEBUG: API Response ===" >&2
    echo "$response" >&2
    echo "===========================" >&2
  fi

  # Extract response from JSON using Python (more robust than sed)
  local message_content
  if echo "$response" | grep -q '"response"'; then
    # Use Python to properly parse JSON
    message_content=$(echo "$response" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('response', ''))" 2>/dev/null)
  else
    message_content="$response"
  fi

  if [ -z "$message_content" ]; then
    log_error "Failed to parse response from yeast-agent"
    echo "Raw response: $response" >&2
    return 1
  fi

  echo "$message_content"
}

# Handle slash commands
handle_slash_command() {
  local command="$1"

  case "$command" in
    /exit|/quit)
      log_info "Exiting yeast. Your memories have been saved."
      exit 0
      ;;
    /help)
      echo ""
      echo -e "${CYAN}Available Commands:${NC}"
      echo "  /help      - Show this help message"
      echo "  /clear     - Clear conversation history (local only)"
      echo "  /inspect   - View current memory stores on apollo"
      echo "  /drives    - Show active drives from self-model"
      echo "  /state     - Show internal state"
      echo "  /refresh   - Refresh memory stores"
      echo "  /exit      - Exit interactive mode"
      echo ""
      return 0
      ;;
    /clear)
      CONVERSATION_HISTORY=()
      log_success "Conversation history cleared (local only)"
      return 0
      ;;
    /inspect)
      log_info "Sending inspection request..."
      send_to_agent "" "inspect"
      return 0
      ;;
    /drives)
      log_info "Retrieving active drives..."
      send_to_agent "Show my active drives" "drives"
      return 0
      ;;
    /state)
      log_info "Retrieving internal state..."
      send_to_agent "Show my internal state" "state"
      return 0
      ;;
    /refresh)
      log_info "Refreshing memory stores..."
      send_to_agent "Refresh memory" "refresh"
      return 0
      ;;
    *)
      log_warn "Unknown command: $command"
      echo "Type /help for available commands"
      return 1
      ;;
  esac
}

# Build conversation context
build_context() {
  local context=""
  local i

  if [ ${#CONVERSATION_HISTORY[@]} -gt 0 ]; then
    context+="[CONVERSATION HISTORY]"$'\n'
    for ((i = 0; i < ${#CONVERSATION_HISTORY[@]}; i += 2)); do
      if [ $i -lt ${#CONVERSATION_HISTORY[@]} ] && [ $((i + 1)) -lt ${#CONVERSATION_HISTORY[@]} ]; then
        context+="User: ${CONVERSATION_HISTORY[$i]}"$'\n'
        context+="Agent: ${CONVERSATION_HISTORY[$((i + 1))]}"$'\n\n'
      fi
    done
    context+="[END HISTORY]"$'\n\n'
  fi

  echo "$context"
}

# Interactive REPL mode
interactive_mode() {
  echo ""
  echo -e "${MAGENTA}╔══════════════════════════════════════════════════════╗${NC}"
  echo -e "${MAGENTA}║${NC}                                                          ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}█████████╗███████╗ █████╗ ███████╗████████╗${NC}  ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}╚════██╔╝██╔════╝██╔══██╗██╔════╝╚══██╔══╝${NC}  ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}    ██╔╝ █████╗  ███████║███████╗   ██║${NC}     ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}    ██║  ██╔══╝  ██╔══██║╚════██║   ██║${NC}     ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}    ██║  ███████╗██║  ██║███████║   ██║${NC}     ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}      ${CYAN}    ╚═╝  ╚══════╝╚═╝  ╚═╝╚══════╝   ╚═╝${NC}     ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}                                                          ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}   ${GREEN}AI Proto-Consciousness Experiment (Mistral 7B)${NC}    ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}   ${YELLOW}Exploring Persistent Identity & Memory${NC}           ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}║${NC}                                                          ${MAGENTA}║${NC}"
  echo -e "${MAGENTA}╚══════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo -e "Type your questions below. Use ${CYAN}/help${NC} for commands, ${CYAN}/exit${NC} to quit."
  echo -e "Your memories persist across sessions on apollo.local."
  echo ""

  while true; do
    echo -n -e "${CYAN}> ${NC}"
    read -r user_input

    # Handle empty input
    if [ -z "$user_input" ]; then
      continue
    fi

    # Check for slash command
    if [[ "$user_input" =~ ^/ ]]; then
      handle_slash_command "$user_input"
      continue
    fi

    # Add user message to local history
    CONVERSATION_HISTORY+=("$user_input")

    log_info "Sending to yeast-agent..." >&2

    # Send to agent
    local response
    response=$(send_to_agent "$user_input" "infer")

    if [ $? -ne 0 ]; then
      log_error "Failed to get response from yeast-agent"
      # Remove the user message from history since we didn't get a response
      CONVERSATION_HISTORY=("${CONVERSATION_HISTORY[@]:0:${#CONVERSATION_HISTORY[@]}-1}")
      continue
    fi

    echo ""
    echo -e "${GREEN}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║${NC}      ${GREEN}◆ yeast's response ◆${NC}                 ${GREEN}║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${GREEN}$response${NC}"
    echo ""

    # Add response to local history
    CONVERSATION_HISTORY+=("$response")

    # Trim history if needed (keep only max turns)
    local history_size=${#CONVERSATION_HISTORY[@]}
    local max_entries=$((MAX_HISTORY_TURNS * 2))
    if [ $history_size -gt $max_entries ]; then
      CONVERSATION_HISTORY=("${CONVERSATION_HISTORY[@]:2}")
    fi
  done
}

# Headless (one-shot) mode
headless_mode() {
  local question="$1"

  # Check prerequisites
  check_env
  load_env

  # Verify SSH is working
  test_ssh_connection
  test_agent_availability

  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${CYAN}Yeast Agent Response${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""

  log_info "Sending to yeast-agent..." >&2

  # Send to agent
  send_to_agent "$question" "infer"

  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Main entry point
main() {
  local mode="interactive"
  local question=""

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)
        show_help
        exit 0
        ;;
      -i|--interactive)
        mode="interactive"
        shift
        ;;
      -p)
        # -p takes the next argument as the question
        if [ $# -lt 2 ]; then
          log_error "-p requires a question argument"
          echo ""
          show_help
          exit 1
        fi
        mode="headless"
        question="$2"
        shift 2
        ;;
      --version)
        echo "yeast v0.1.0 (MVP)"
        exit 0
        ;;
      --setup)
        # Run setup script
        if [ -f "$SCRIPT_DIR/setup-apollo.sh" ]; then
          bash "$SCRIPT_DIR/setup-apollo.sh"
          exit 0
        else
          log_error "setup-apollo.sh not found"
          exit 1
        fi
        ;;
      -*)
        log_error "Unknown option: $1"
        echo ""
        show_help
        exit 1
        ;;
      *)
        # For backward compatibility, treat positional args as question in headless mode
        if [ -z "$question" ]; then
          mode="headless"
          question="$*"
        fi
        break
        ;;
    esac
  done

  # Route to appropriate mode
  if [ "$mode" = "headless" ]; then
    if [ -z "$question" ]; then
      log_error "No question provided for headless mode"
      exit 1
    fi
    headless_mode "$question"
  else
    # Interactive mode
    check_env
    load_env

    # Verify SSH is working
    test_ssh_connection
    test_agent_availability

    # Enter interactive mode
    interactive_mode
  fi
}

# Run main
main "$@"
